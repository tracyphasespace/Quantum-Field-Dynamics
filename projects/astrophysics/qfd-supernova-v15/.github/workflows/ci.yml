name: V15 QFD Pipeline CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "No requirements.txt found"
          pip install pytest ruff black mypy pandas numpy jax jaxlib numpyro

      - name: Lint with ruff
        run: |
          ruff check . --exit-non-zero-on-fix || true

      - name: Format check with black
        run: |
          black --check . || true

      - name: Type check with mypy
        run: |
          mypy src/v15_model.py src/stage2_mcmc_numpyro.py --ignore-missing-imports || true

      - name: Run spec guard (forbid (1+z))
        run: python scripts/spec_guard.py

      - name: Run contract tests
        run: pytest tests/test_spec_contracts.py -v

      - name: Run all unit tests
        run: pytest tests/ -v --ignore=tests/test_alpha_pred_properties.py || true

  smoke-test:
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "No requirements.txt found"
          pip install pandas numpy jax jaxlib numpyro scipy matplotlib

      - name: Generate smoke10 mock data
        run: |
          python scripts/generate_mock_data.py --n-sne 10 --out data/smoke10.csv

      - name: Run Stage 1 (smoke)
        run: |
          python src/stage1_optimize.py \
            --lightcurves data/smoke10.csv \
            --out results/smoke10/stage1 \
            --global "70.0,0.01,30.0" \
            --tol 1e-3 \
            --max-iters 200

      - name: Run Stage 2 (smoke - 200 steps)
        run: |
          python src/stage2_mcmc_numpyro.py \
            --stage1 results/smoke10/stage1 \
            --out results/smoke10/stage2 \
            --num-warmup 100 \
            --num-samples 200 \
            --num-chains 2

      - name: Run Stage 3 (smoke)
        run: |
          python src/stage3_hubble_optimized.py \
            --stage1 results/smoke10/stage1 \
            --stage2 results/smoke10/stage2/posterior_samples.csv \
            --out results/smoke10/stage3

      - name: Check smoke outputs exist
        run: |
          test -f results/smoke10/stage3/summary_overall.csv || exit 1
          echo "âœ“ Smoke test outputs generated successfully"

      - name: Compare goldens (if available)
        run: |
          if [ -f goldens/smoke10_summary_overall.csv ]; then
            python scripts/compare_goldens.py \
              results/smoke10/stage3/summary_overall.csv \
              goldens/smoke10_summary_overall.csv
          else
            echo "No goldens found, skipping comparison"
          fi
