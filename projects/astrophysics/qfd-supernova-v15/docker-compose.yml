version: '3.8'

services:
  qfd-supernova-v15:
    build: .
    image: qfd-supernova-v15:latest
    container_name: qfd-supernova-analysis

    # Enable GPU support (requires nvidia-docker)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    # Mount volumes for data persistence
    volumes:
      - ./results:/app/results
      - ./data:/app/data:ro  # Read-only data mount

    # Environment variables
    environment:
      - PYTHONUNBUFFERED=1
      - XLA_FLAGS=--xla_cpu_multi_thread_eigen=false
      - JAX_PLATFORM_NAME=gpu  # Use GPU by default

    # Override default command for interactive use
    # Run: docker-compose run qfd-supernova-v15 python src/stage1_persn_sweep.py ...
    command: /bin/bash

    # Keep container running for interactive sessions
    stdin_open: true
    tty: true
